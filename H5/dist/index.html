<!DOCTYPE html>
<html>
<head>
		<title>EasyClient</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<link rel="stylesheet" href="./adminlte-2.3.6/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/font-awesome-4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/ionicons-2.0.1/css/ionicons.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/dist/css/AdminLTE.min.css">
	<link rel="stylesheet" href="./adminlte-2.3.6/dist/css/skins/skin-green.min.css">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

	<script src="./adminlte-2.3.6/plugins/jQuery/jquery-2.2.3.min.js"></script>
	<script src="./adminlte-2.3.6/bootstrap/js/bootstrap.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/jQueryMobile/jquery.mobile.custom.min.js"></script>
	<script src="./adminlte-2.3.6/dist/js/app.js"></script>
	<script src="./adminlte-2.3.6/plugins/slimScroll/jquery.slimscroll.min.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/iCheck/all.css">
	<script src="./adminlte-2.3.6/plugins/iCheck/icheck.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/md5/jquery.md5.js"></script>
	<script src="./adminlte-2.3.6/plugins/input-number/jquery.inputnumber.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/gritter/jquery.gritter.css">
	<script src="./adminlte-2.3.6/plugins/gritter/jquery.gritter.js"></script>
	<link rel="stylesheet" href="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.css">
	<script src="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.js"></script>
	<script src="./adminlte-2.3.6/plugins/ellipsis/jquery.ellipsis.js"></script>
	<script src="./adminlte-2.3.6/plugins/validator/validator.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/bootbox/bootbox.min.js"></script>
	<script src="./adminlte-2.3.6/plugins/cookie/jquery.cookie.min.js"></script>

	<link rel="stylesheet" href="./css/common.css">
	<script src="./js/common.js"></script>
	<style>
		.main-header .logo {
			line-height: 48px;
			background-color: transparent;
		}

		.main-header .logo .logo-lg img {
			width: 35px;
			height: 35px;
		}
		.main-header .navbar-custom-menu {
			float: left;
			padding: 0;
		}
		.main-header .navbar-custom-menu .navbar-nav li {
			padding: 0;
		}

		.input-group .input-group-addon {
			background-color: #eee;
		}	
		.camera {
			padding: 0 10px;
		}
		.camera .thumbnail {
			position : relative;
		}
		.camera .camera-type {
			position: absolute;
			height: 14px;
			line-height: 10px;
			font-size : 8px;
			color : #FFF;
			right: 5px;
			bottom: 5px;
			background-color:rgba(255,255,255,0.4);
			padding: 2px 5px;
			border-radius: 2px;
		}
		.camera .thumbnail .caption {
			padding:5px;
		}
		.camera .mask {
			display : none;
			position : absolute;
			top:0;left:0;right:0;bottom:0;
			background:rgba(255,255,255,0.5);
		}
		.camera.offline .mask {
			display : block;
		}
	</style>
</head>
<body class="hold-transition skin-green fixed layout-top-nav">
	<div class="wrapper">
		<header class="main-header">
			<a href="#" class="logo visible-xs">
				<span class="logo-lg"><img src="./images/logo.png" class="img-rounded"> EasyClient</span>
			</a>
			<nav class="navbar navbar-static-top" role="navigation">
				<a href="#" class="logo hidden-xs" style="background: transparent;">
					<span class="logo-lg"><img src="./images/logo.png" class="img-rounded"> EasyClient</span>
				</a>
				<div class="navbar-custom-menu col-xs-12 col-sm-6">
					<ul class="nav navbar-nav text-center" style="float:none;">
						<li class="col-xs-4">
							<a href="#tab-camera" data-toggle="tab" role="tab">EasyCamera</a>
						</li>
						<li class="col-xs-4">
							<a href="#tab-mobile" data-toggle="tab" role="tab">移动设备</a>
						</li>
						<li class="col-xs-4">
							<a href="#tab-nvr" data-toggle="tab" role="tab">EasyNVR</a>
						</li>
					</ul>
				</div>
			</nav>
		</header>

		<div class="content-wrapper">
			<section class="content" style="padding:10px 0;">
				<div class="tab-content container-fluid no-padding no-margin">
					<div class="tab-pane fade" id="tab-camera">
						<div class="col-sm-12 text-green">
							<div class="box box-default box-solid">
								<div class="box-header with-border text-green" data-toggle="collapse" role="button" data-target="#camera-desc">
									<i class="fa fa-question-circle"></i> EasyCamera ARM摄像机接入说明:
								</div>
								<div class="box-collapse collapse" id="camera-desc">
									<div class="box-body">
										EasyCamera ARM摄像机服务是一套独立于各个厂家芯片的对接服务，通过将EasyCamera ARM服务内置到各个硬件摄像机厂家（海康、大华、雄迈等）的摄像机嵌入式系统中，与平台进行交互，控制摄像机的音视频、对讲、PTZ、更新配置、重启服务等动作；
										<br>
										EasyCamera ARM摄像机样机：<a href="http://www.easydarwin.org/camera">http://www.easydarwin.org/camera</a>
										<br>
										<img src="./images/easycamera_arm.png" alt="EasyCamera ARM" style="width:150px;height: 150px;">
										<br>
									</div>
								</div>
							</div>	
						</div>							
					</div>
					<div class="tab-pane fade" id="tab-mobile">
						<div class="col-sm-12 text-green">
							<div class="box box-default box-solid">
								<div class="box-header with-border text-green" data-toggle="collapse" role="button" data-target="#mobile-desc">
									<i class="fa fa-question-circle"></i> EasyCamera移动单兵App接入说明:
								</div>
								<div class="box-collapse collapse" id="mobile-desc">
									<div class="box-body">
										以 Android,iOS 手机做为摄像机视频源,接入到 EasyDarwin 云平台对外提供音视频服务!
										<br>
										<br>
										EasyCamera 移动端版本下载:<br>
										1、Android：<a href="http://fir.im/EasyCamera">http://fir.im/EasyCamera</a><br>
										2、iOS：在AppStore搜索'EasyCamera'<br>										
										<br>
										或者通过手机扫码下载:<br>
										<br>
										<img src="./images/qr_easy_camera.png" alt="EasyCamera" style="width:150px;height: 150px;">
									</div>
								</div>
							</div>	
						</div>						
					</div>
					<div class="tab-pane fade" id="tab-nvr">
						<div class="col-sm-12 text-green">
							<div class="box box-default box-solid">
								<div class="box-header with-border text-green" data-toggle="collapse" role="button" data-target="#nvr-desc">
									<i class="fa fa-question-circle"></i> EasyNVR设备接入说明:
								</div>
								<div class="box-collapse collapse" id="nvr-desc">
									<div class="box-body">
										EasyNVR是一款能够将各个厂家的通用RTSP/ONVIF摄像机接入，并整合成为全平台直播的综合服务，EasyNVR能够接入到EasyDarwin云平台，接收EasyDarwin云平台对各个通道摄像机的音视频、转动等操作指令，将通用的安防摄像机接入到统一平台中，常用在幼儿园视频、智能家居、智慧社区、智慧农业等项目应用中！
										<br>
										<br>
										版本下载: <a href="http://github.com/EasyDarwin/EasyNVR">http://github.com/EasyDarwin/EasyNVR</a>
									</div>
								</div>
							</div>	
						</div>
					</div>
				</div>
			</section>
		</div>
		<!-- content-wrapper -->
		<div class="container-fluid" style="background-color:#2a2a2a;color:#979797;padding:20px 10px;">
    <div class="row">
        <div class="hidden-xs col-sm-3">
            <table style="width:100%;height: 120px;">
                <tr>
                    <td style="vertical-align: middle;text-align: right;"><a href="./download_easy_client.html"><i class="fa fa-download"></i> EasyClient App下载</a></td>
                </tr>
            </table>            
        </div>
        <div class="col-xs-12 col-sm-9 col-md-7">
            <div style="overflow: hidden;position: relative;min-height: 120px;">
                <div style="width:120px;position: absolute;left:0;top:0;bottom: 0;">
                    <table style="width:100%;height: 100%;">
                        <tr>
                            <td style="vertical-align: middle;text-align: center;"><img src="./images/qr_easy_client.png" alt="EasyClient" style="width:120px;height:120px;"></td>
                        </tr>
                    </table>
                </div>
                <p style="margin:0;margin-left: 140px;">
                    EasyDarwin流媒体云平台是一套开源流媒体平台框架，能够直接接入各种类型摄像机、移动手持/单兵设备，还能将各种现场已经部署的摄像机通过EasyNVR的内网服务接入到云平台，实现设备的统一接入、管理与控制。支持PC、WEB、Android、iOS、H5全平台客户端接入！
                </p>
            </div>
        </div>
    </div>
</div>
<footer class="main-footer">
    <div class="pull-right">
        EasyClient H5版:v1.1
    </div>
    EasyDarwin云平台:v1.1
</footer>
	</div>
	<!-- wrapper-->
	<script>
		var _url = "http://121.40.50.44:10015/api/v1";
		function renderCamera($camera){
			var camera = $camera.data("camera");
			var snap = camera["SnapURL"] || "./images/snap.png";
			$camera.find("img").attr("src",snap).attr("alt",camera["Name"]);
			$camera.find(".camera-name").text(camera["Name"]);
			$camera.find(".camera-serail").text(camera["Serial"]);
			$camera.find(".camera-type").text(camera["TerminalType"]);
			$camera.find('.caption').ellipsis();
		}
		function renderNvr($camera){
			var camera = $camera.data("camera");
			$camera.find(".box-header").attr("data-target","#"+camera["Serial"]);
			$camera.find(".box-collapse").attr("id",camera["Serial"]);
			$camera.find(".camera-name").text(camera["Name"]);
			$camera.find(".camera-serial").text(camera["Serial"]);
			$camera.find(".camera-type").text(camera["TerminalType"]);
			$camera.find('.box-header').ellipsis();
		}
		function renderNvrChannel($camera){
			var camera = $camera.data("camera");
			var snap = camera["SnapURL"] || "./images/snap.png";
			$camera.find("img").attr("src",snap).attr("alt",camera["Name"]);
			$camera.find(".channel-name").text(camera["Name"]).ellipsis();
			$camera.find(".channel-status").ellipsis();
			$camera.find(".channel").text(camera["Channel"]);
			if((camera["Status"]||"").toLowerCase() ==  "online"){
				$camera.find(".channel-status-text").text("在线");
				$camera.find(".caption").addClass("text-green");
			}else{
				$camera.addClass("offline");
				$camera.find(".channel-status-text").text("不在线");
			}
		}
		function getEasyCamera(){
			var devs = [];
			$.get(_url + "/getdevicelist?AppType=EasyCamera&TerminalType=ARM_Linux").then(function(data){
				try{
					var ret = data;
					devs = ret.EasyDarwin.Body.Devices||[];
					devs.sort(function(a,b){
						if((a["Serial"]||"") < (b["Serial"]||"")){
							return -1;
						}else if((a["Serial"]||"") == (b["Serial"]||"")){
							return 0;
						}else {
							return 1;
						}
					});
					return $.get("./camera-template.html");
				}catch(e){
					console.log(e);
					return $.Deferred().reject();
				}
			}).then(function(html){
				$.each(devs,function(i,camera){
					var $camera = $(html);
					$("#tab-camera").append($camera);
					$camera.data("camera",camera);
					renderCamera($camera);
				})
			}).fail(function(){
				$.gritter.add("获取EasyCamera数据失败");
			})
		}
		function getMobile(){
			var devs = [];
			$.get(_url + "/getdevicelist?AppType=EasyCamera&TerminalType=iOS|Android").then(function(data){
				try{
					var ret = data;
					devs = ret.EasyDarwin.Body.Devices||[];
					devs.sort(function(a,b){
						if((a["Serial"]||"") < (b["Serial"]||"")){
							return -1;
						}else if((a["Serial"]||"") == (b["Serial"]||"")){
							return 0;
						}else {
							return 1;
						}
					});
					return $.get("./mobile-template.html");				
				}catch(e){
					console.log(e);
					return $.Deferred().reject();
				}
			}).then(function(html){
				$.each(devs,function(i,camera){
					var $camera = $(html);
					$("#tab-mobile").append($camera);
					$camera.data("camera",camera);
					renderCamera($camera);
				})
			}).fail(function(){
				$.gritter.add("获取移动设备数据失败");
			})
		}
		function getEasyNVR(){
			var devs = [];
			$.get(_url + "/getdevicelist?AppType=EasyNVR").then(function(data){
				try{
					var ret = data;
					devs = ret.EasyDarwin.Body.Devices||[];
					devs.sort(function(a,b){
						if((a["Serial"]||"") < (b["Serial"]||"")){
							return -1;
						}else if((a["Serial"]||"") == (b["Serial"]||"")){
							return 0;
						}else{
							return 1;
						}
					});
					return $.ajax("./nvr-template.html",{cache : false});				
				}catch(e){
					console.log(e)
					return $.Deferred().reject();
				}
			}).then(function(html){
				$.each(devs,function(i,camera){
					var $camera = $(html);
					$("#tab-nvr").append($camera);
					if(i%2 == 1){
						$("#tab-nvr").append("<div class='clearfix'></div>");
					}
					$camera.data("camera",camera);
					renderNvr($camera);
				});				
			}).fail(function(){
				$.gritter.add("获取EasyNVR数据失败");
			});
		}
		$(function(){
			if('ontouchstart' in document.documentElement){
				$(".content-wrapper").swiperight(function(){
					var $tab = $(".navbar-custom-menu ul li.active").prev();
					if($tab.length == 1){
						$tab.find("a").trigger("click");
					}
				}).swipeleft(function(){
					var $tab = $(".navbar-custom-menu ul li.active").next();
					if($tab.length == 1){
						$tab.find("a").trigger("click");
					}
				})
			}
			$(document).on("show.bs.tab",".navbar-custom-menu [data-toggle=tab]",function(e){
				var target = $(this).attr("href");
				$.cookie("target",target);
				$(target + "> .camera, " + target + ">.nvr").remove();
				switch(target){
					case "#tab-camera":
						getEasyCamera();
					break;
					case "#tab-mobile":
						getMobile();
					break;
					case "#tab-nvr":
						getEasyNVR();
					break;
				}
			});
			$(".navbar-custom-menu [data-toggle=tab][href='{0}']".format($.cookie('target')||"#tab-camera")).trigger("click");
			$(document).on("show.bs.collapse hide.bs.collapse",".nvr .box-collapse",function(e){
				var $box = $(this).closest(".box");
				var camera = $(this).closest(".nvr").data("camera");
				var cls = "fa-chevron-";
				if(e.type == 'show'){
					cls += "up";
					if($(this).attr("id") !== "nvr-desc"){
						$box.find(".box-body > .camera").remove();
						$("body").mask("正在请求通道信息...",300);
						$.get(_url + "/getdeviceinfo?device=" + camera["Serial"]).always(function(){
							$("body").unmask();
						}).done(function(data){
							try{
								var ret = data;
								var channels = ret.EasyDarwin.Body.Channels||[];
								channels.sort(function(a,b){
									if((a["Name"]||"") < (b["Name"]||"")){
										return -1;
									}else if((a["Name"]||"") == (b["Name"]||"")){
										return 0;
									}else {
										return 1;
									}
								});
								$.each(channels,function(i,channel){
									var html = $(".nvr-channel-template").html();
									var $camera = $(html);
									$box.find(".box-body").append($camera);
									$camera.data("camera",channel);
									renderNvrChannel($camera);
								})
							}catch(e){
								$.gritter.add("请求通道信息失败!");
								console.log(e);
							}
						}).fail(function(xhr,ts,e){
							$.gritter.add("请求通道信息失败!");
						})
					}
				}else{
					cls += "down";
				}
				$box.find(".box-header i.fa").removeClass("fa-chevron-down").removeClass("fa-chevron-up").addClass(cls);
			})

			$(document).on("click",".camera .thumbnail img",function(){
				var $img = $(this);
				var $camera = $img.closest(".camera");
				var camera = $camera.data("camera");
				var channel = "";
				var serial = camera["Serial"];
				if(!serial){
					var $nvr = $img.closest(".nvr");
					var nvr = $nvr.data("camera");
					serial = nvr["Serial"];
					channel = camera["Channel"];
				}
				var params = ["device=" + serial,"reserve=1"];
				if(channel){
					params.push("channel=" + channel);
				}
				$("body").mask("正在请求EasyCMS启动视频...",300);
				var msg = "启动视频失败!";
				var videoLiveUrl = "http://{IP}:{Port}/api/v1/livedevicestream?device={Serial}&channel={Channel}&protocol={Protocol}";
				$.ajax({
					type : "GET",
					url : _url + "/startdevicestream?" + params.join("&")
				}).then(function(data){
					$("body").unmask();
					try{
						var ret = data;
						if(ret.EasyDarwin.Header.ErrorNum !== "200"){
							msg += ret.EasyDarwin.Header.ErrorString;
							return $.Deferred().reject();
						}
						var result = $.extend({},ret.EasyDarwin.Body);
						var videoUrl = "http://{IP}:{Port}/api/v1/getdevicestream?device={Serial}&channel={Channel}&protocol={Protocol}&reserve={Reserve}";
						var service = result["Service"].split(";");
						for(var i in service){
							var kv = service[i];
							var _kv = kv.split("=");
							result[_kv[0]] = _kv[1];
						}
						result["Protocol"] = isPC() ? "rtmp" : "hls";
						videoUrl = videoUrl.format(result);
						videoLiveUrl = videoLiveUrl.format(result);
						$("body").mask("正在请求EasyDarwin直播流地址...",300);
						msg = "获取视频流失败!";
						return $.ajax({
							type : "GET",
							url : videoUrl
						});					
					}catch(e){
						console.log(msg + " data : " + data);
						return $.Deferred().reject();
					}
				}).then(function(data){
					$("body").unmask();
					try{
						var ret = data;
						if(ret.EasyDarwin.Header.ErrorNum !== "200"){
							msg += ret.EasyDarwin.Header.ErrorString;
							return $.Deferred().reject();
						}						
						$.cookie("videoUrl",ret.EasyDarwin.Body.URL);
						$.cookie("videoLiveUrl",videoLiveUrl);
						$.cookie("videoTitle",camera["Name"]);
						$.cookie("videoImg",camera["SnapURL"]);
						$.cookie("isReady",ret.EasyDarwin.Body.IsReady);
						top.location.href = "./vplay.html";
					}catch(e){
						console.log(e);
						console.log(data);
						return $.Deferred().reject();
					}
				}).fail(function(){
					$("body").unmask();
					$.gritter.add(msg);
				})
			})
		})
	</script>
</body>

</html>